name: Lighthouse CI
on:
  pull_request:
    branches: ["main", "develop"]
  workflow_dispatch: # Allow manual trigger to register check

permissions:
  contents: read
  pull-requests: write
  statuses: write
  actions: write

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Build
        working-directory: frontend
        run: npm run build

      - name: Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          configPath: "./frontend/lighthouserc.json"
          uploadArtifacts: false
          temporaryPublicStorage: false

      - name: Upload Lighthouse Results
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-results
          path: .lighthouseci/

      - name: Comment on Results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const fs = require('fs');
              const path = require('path');
              
              // Debug info
              console.log('Current directory:', process.cwd());
              const reportDir = '.lighthouseci';
              
              if (!fs.existsSync(reportDir)) {
                 console.log('Report directory not found at:', reportDir);
                 return;
              }
              
              console.log('Report directory contents:', fs.readdirSync(reportDir));
              
              const files = fs.readdirSync(reportDir).filter(f => f.endsWith('.json'));
              if (files.length === 0) {
                console.log('No JSON report files found');
                return;
              }
              
              const reportPath = path.join(reportDir, files[0]);
              console.log('Reading report from:', reportPath);
              
              const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
              
              if (!report.categories || !report.audits) {
                 console.log('Report is missing categories or audits structure.');
                 return;
              }

              const failures = [];
              
              // Categories under 0.9
              for (const category of Object.values(report.categories)) {
                  if (category.score < 0.9) {
                      failures.push(`**${category.title}**: ${(category.score * 100).toFixed(0)}%`);
                  }
              }
              
              // Critical Audits
              for (const audit of Object.values(report.audits)) {
                  if (audit.score === 0 || audit.scoreDisplayMode === 'error') {
                       if (audit.id !== 'is-on-https') {
                          failures.push(`- **${audit.title}**: ${audit.displayValue || ''} _(${audit.id})_`);
                       }
                  }
              }
              
              if (failures.length > 0) {
                 if (!context.issue || !context.issue.number) {
                    console.log('No issue number found (not a PR?), skipping comment.');
                    console.log('Failures found:', failures);
                    return;
                 }

                 console.log('Posting comment with suggestions...');
                 const body = `### ðŸ’¡ Lighthouse Suggestions\n\n${failures.join('\n')}\n\n[View Full Report](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`;
                 
                 await github.rest.issues.createComment({
                     owner: context.repo.owner,
                     repo: context.repo.repo,
                     issue_number: context.issue.number,
                     body: body
                 });
              } else {
                console.log('No failures found in report to comment about.');
              }
            } catch (error) {
              console.error('Error in comment script:', error);
            }
