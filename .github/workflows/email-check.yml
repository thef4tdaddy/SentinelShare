name: Email Processing

on:
  schedule:
    # Run every 2 hours (12 times per day) - balanced safety vs. usage
    - cron: '0 */2 * * *'
    # Alternatives based on your needs:
    # Every hour (uses ~2000 min/month): - cron: '0 * * * *'
    # Every 3 hours (uses ~500 min/month): - cron: '0 */3 * * *'
    # Also run on manual trigger
  workflow_dispatch:
    inputs:
      mode:
        description: 'Processing mode'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - regular
          - manual
          - replies

jobs:
  process-emails:
    runs-on: ubuntu-latest
    
    steps:
    - name: Process Regular Email Checks
      if: ${{ github.event.inputs.mode == 'all' || github.event.inputs.mode == 'regular' || github.event.inputs.mode == '' }}
      run: |
        echo "üîç Processing regular email checks..."
        
        # Add timeout and better error handling
        response=$(timeout 60 curl -s -X GET \
          "${{ secrets.VERCEL_APP_URL }}/api/check-emails" \
          -H "Content-Type: application/json" \
          -H "User-Agent: GitHub-Actions-Email-Processor" \
          --max-time 55 \
          --retry 2 \
          --retry-delay 5 \
          --fail-with-body) || {
          echo "‚ùå curl command failed or timed out"
          exit 1
        }
        
        echo "Regular check response: $response"
        
        # Check if response is valid JSON and contains success
        if echo "$response" | jq -e '.success == true' > /dev/null 2>&1; then
          echo "‚úÖ Regular email check completed successfully"
          # Extract stats if available
          processed=$(echo "$response" | jq -r '.processed // "unknown"')
          forwarded=$(echo "$response" | jq -r '.forwarded // "unknown"')
          echo "üìä Processed: $processed, Forwarded: $forwarded"
        elif echo "$response" | jq -e '.success == false' > /dev/null 2>&1; then
          echo "‚ùå API returned failure response"
          error=$(echo "$response" | jq -r '.error // "Unknown error"')
          details=$(echo "$response" | jq -r '.details // ""')
          echo "Error: $error"
          if [ -n "$details" ]; then
            echo "Details: $details"
          fi
          exit 1
        else
          echo "‚ùå Invalid or unexpected response format"
          echo "Response: $response"
          exit 1
        fi

    - name: Process Manual Forward Rules
      if: ${{ github.event.inputs.mode == 'all' || github.event.inputs.mode == 'manual' || github.event.inputs.mode == '' }}
      run: |
        echo "üéØ Processing manual forward rules..."
        
        response=$(timeout 60 curl -s -X GET \
          "${{ secrets.VERCEL_APP_URL }}/api/manual-forward?mode=auto&hours=4" \
          -H "Content-Type: application/json" \
          -H "User-Agent: GitHub-Actions-Email-Processor" \
          --max-time 55 \
          --retry 2 \
          --retry-delay 5 \
          --fail-with-body) || {
          echo "‚ùå curl command failed or timed out"
          exit 1
        }
        
        echo "Manual forward response: $response"
        
        # Check if response is valid JSON and contains success
        if echo "$response" | jq -e '.success == true' > /dev/null 2>&1; then
          echo "‚úÖ Manual forward processing completed successfully"
        elif echo "$response" | jq -e '.success == false' > /dev/null 2>&1; then
          echo "‚ùå API returned failure response"
          error=$(echo "$response" | jq -r '.error // "Unknown error"')
          echo "Error: $error"
          exit 1
        else
          echo "‚ùå Invalid or unexpected response format"
          echo "Response: $response"
          exit 1
        fi

    - name: Process Reply Commands
      if: ${{ github.event.inputs.mode == 'all' || github.event.inputs.mode == 'replies' || github.event.inputs.mode == '' }}
      run: |
        echo "üí¨ Processing reply commands..."
        
        response=$(timeout 60 curl -s -X GET \
          "${{ secrets.VERCEL_APP_URL }}/api/process-replies" \
          -H "Content-Type: application/json" \
          -H "User-Agent: GitHub-Actions-Email-Processor" \
          --max-time 55 \
          --retry 2 \
          --retry-delay 5 \
          --fail-with-body) || {
          echo "‚ùå curl command failed or timed out"
          exit 1
        }
        
        echo "Reply processing response: $response"
        
        # Check if response is valid JSON and contains success
        if echo "$response" | jq -e '.success == true' > /dev/null 2>&1; then
          echo "‚úÖ Reply processing completed successfully"
        elif echo "$response" | jq -e '.success == false' > /dev/null 2>&1; then
          echo "‚ùå API returned failure response"
          error=$(echo "$response" | jq -r '.error // "Unknown error"')
          echo "Error: $error"
          exit 1
        else
          echo "‚ùå Invalid or unexpected response format"
          echo "Response: $response"
          exit 1
        fi

    - name: Send Status Summary
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "üéâ All email processing completed successfully at $(date)"
        else
          echo "‚ö†Ô∏è Some email processing failed at $(date)"
        fi